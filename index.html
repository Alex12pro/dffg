<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ball Bouncer</title>
  <style>
    :root{
      --bg0:#070a12; --bg1:#0b1220;
      --stroke:rgba(255,255,255,.12);
      --text:#e9f0ff; --muted:rgba(233,240,255,.68);
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 50% 20%, rgba(70,140,255,.25), transparent 55%),
        radial-gradient(900px 650px at 60% 80%, rgba(0,255,170,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 36px}
    header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:18px}
    .title{
      font-size:38px;font-weight:900;letter-spacing:.4px;line-height:1.05;margin:0;
      background: linear-gradient(90deg, #38bdf8 0%, #34d399 55%, #22c55e 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow: 0 0 24px rgba(56,189,248,.08);
      user-select:none;white-space:nowrap;
    }
    
    .titleBlock{display:flex;flex-direction:column;gap:6px}
    .subtitle{
      font-size:18px;font-weight:900;letter-spacing:.25px;line-height:1;
      background: linear-gradient(90deg, #38bdf8 0%, #34d399 55%, #22c55e 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      opacity:.92; user-select:none;
    }

    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:10px 12px;border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke); box-shadow: 0 10px 35px rgba(0,0,0,.35);
      backdrop-filter: blur(10px); display:flex; align-items:center; gap:10px; min-height:42px;
    }
    .pill .k{color:var(--muted);font-size:12px;letter-spacing:.2px}
    .pill .v{font-weight:800;font-variant-numeric: tabular-nums}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}header{flex-direction:column;align-items:flex-start}.title{font-size:34px}.topRight{justify-content:flex-start}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cardHead h2{margin:0;font-size:14px;letter-spacing:.35px;color:rgba(233,240,255,.85);font-weight:800;text-transform:uppercase}
    .hint{font-size:12px;color:rgba(233,240,255,.55)}

    .play{padding:18px 16px;position:relative;min-height:520px}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:26px 14px 18px}
    .ballWrap{width:min(320px, 70vw);aspect-ratio:1/1;position:relative;display:grid;place-items:center;user-select:none}

    .ball{
      width:100%;height:100%;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 90px rgba(0,0,0,.55), inset 0 0 30px rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .08s ease, filter .08s ease;
      background-position:center;
      background-repeat:no-repeat;
      background-size:contain; /* never crop */
    }
    .ball:active{transform: scale(.985); filter: brightness(1.02) saturate(1.03);}

    .floating{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.2px;font-variant-numeric: tabular-nums;text-shadow: 0 10px 20px rgba(0,0,0,.45);opacity:0;transform: translateY(10px) scale(.98);transition: opacity .22s ease, transform .22s ease}
    .floating.show{opacity:1;transform: translateY(-10px) scale(1)}

    .statRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .mini{padding:10px 12px;border-radius:14px;background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);min-width:160px;text-align:center}
    .mini .k{font-size:12px;color:rgba(233,240,255,.62)}
    .mini .v{font-size:16px;font-weight:900;margin-top:2px;font-variant-numeric: tabular-nums}
    .sub{margin:0;color:rgba(233,240,255,.66);font-size:13px;text-align:center;max-width:560px;line-height:1.45}

    .row2{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .smallBtn{padding:10px 12px;border-radius:12px;background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);font-weight:900;cursor:pointer;transition: transform .08s ease, background .18s ease}
    .smallBtn:hover{background: rgba(255,255,255,.09)}
    .smallBtn:active{transform: scale(.985)}

    .shopBody{padding:12px}
    .list{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto;padding-right:4px}
    .list::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12);border-radius:999px;border:2px solid rgba(0,0,0,.35)}
    .item{border:1px solid rgba(255,255,255,.10);border-radius:16px;background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.035));padding:12px;display:grid;grid-template-columns:44px 1fr auto;gap:12px;align-items:center}
    .item.locked{opacity:.55;filter:saturate(.9)}
    .badge{
      width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 18px rgba(255,255,255,.06);
      background-position:center;
      background-repeat:no-repeat;
      background-size:contain; /* never crop */
    }
    .name{font-weight:900;margin:0;font-size:14px;letter-spacing:.2px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{margin:4px 0 0;color:rgba(233,240,255,.65);font-size:12px;line-height:1.3;font-variant-numeric: tabular-nums}
    .btn{border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer;transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;min-width:118px;text-align:center;font-variant-numeric: tabular-nums}
    .btn:hover{background: rgba(255,255,255,.09);border-color: rgba(255,255,255,.20)}
    .btn:active{transform: scale(.985)}
    .btn:disabled{cursor:not-allowed;opacity:.55}

    .toast{position:fixed;left:50%;bottom:18px;transform: translateX(-50%);padding:10px 12px;border-radius:999px;background: rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.10);backdrop-filter: blur(12px);color: rgba(233,240,255,.88);box-shadow: 0 14px 55px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition: opacity .25s ease, transform .25s ease;font-size:13px}
    .toast.show{opacity:1;transform: translateX(-50%) translateY(-4px)}
    .foot{margin-top:14px;color:rgba(233,240,255,.45);font-size:12px;text-align:center;user-select:none}
  
    .toggleGroup{display:flex;gap:8px;align-items:center}
    .togBtn{
      padding:8px 10px;border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(233,240,255,.86);
      font-weight:900; cursor:pointer;
      transition: background .18s ease, transform .08s ease, border-color .18s ease;
      font-variant-numeric: tabular-nums;
    }
    .togBtn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.20)}
    .togBtn:active{transform: scale(.985)}
    .togBtn.active{
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(34,197,94,.10));
      border-color: rgba(56,189,248,.35);
      color: rgba(233,240,255,.95);
    }
    .rebirthBtn{
      background: linear-gradient(180deg, rgba(56,189,248,.16), rgba(34,197,94,.10));
      border-color: rgba(56,189,248,.22);
    }
    .rebirthBtn:hover{background: linear-gradient(180deg, rgba(56,189,248,.22), rgba(34,197,94,.14))}

  
    /* --- Dev Panel (hidden until unlocked by code) --- */
    #devPanelBackdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    #devPanel{
      width:min(520px, 92vw);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      padding: 16px;
    }
    #devPanel h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.35px;
      color: rgba(233,240,255,.85);
      font-weight: 900;
      text-transform: uppercase;
    }
    .devRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:12px}
    .devGrid{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px}
    .devInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(233,240,255,.92);
      outline: none;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    .devHelp{color: rgba(233,240,255,.62); font-size: 12px; line-height:1.35}

  
        /* --- Bouncy Box Arena --- */
    .arenaWrap{
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 22px;
      border: 2px solid rgba(255,255,255,.18);
      background: radial-gradient(120% 120% at 30% 20%, rgba(56,189,248,.12), rgba(255,255,255,.04) 40%, rgba(0,0,0,.12) 100%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 18px 70px rgba(0,0,0,.35);
      overflow: hidden;
    }
    .arenaWrap::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      pointer-events:none;
    }
    #arena{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
    }
    .arenaHint{
      position:absolute;
      left: 12px; right: 12px; bottom: 10px;
      text-align:center;
      font-size: 12px;
      color: rgba(233,240,255,.68);
      user-select:none;
      pointer-events:none;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }


  
    #arenaUpgList{margin-top:10px; display:flex; flex-direction:column; gap:10px}
  
    /* Arena Upgrade buttons - themed */
    #arenaUpgList .buyBtn{
      min-width: 120px;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 900;
      letter-spacing: .2px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(56,189,248,.24), rgba(34,197,94,.18));
      color: rgba(235,245,255,.92);
      box-shadow: 0 10px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.10);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    #arenaUpgList .buyBtn:hover:not(:disabled){
      transform: translateY(-1px);
      filter: brightness(1.06);
    }
    #arenaUpgList .buyBtn:active:not(:disabled){
      transform: translateY(0px) scale(.99);
      filter: brightness(1.02);
    }
    #arenaUpgList .buyBtn:disabled{
      opacity: .45;
      filter: grayscale(.25);
      cursor: not-allowed;
      box-shadow: none;
    }

  
  .rightWrap .card{flex:unset}
  }


  /* Right column: keep Ball Shop width like original, add Arena Upgrades next to it */
  .rightWrap{display:flex;flex-direction:row;gap:18px;align-items:stretch}
  .rightWrap .card.shopCard{flex:0 0 520px; min-width:520px; max-width:520px}
  .rightWrap .card.arenaCard{flex:1 1 auto; min-width:340px}
  @media (max-width: 980px){
    .rightWrap{flex-direction:column}
    .rightWrap .card.shopCard{flex:unset; min-width:unset; max-width:unset}
    .rightWrap .card.arenaCard{flex:unset; min-width:unset}
  }


  .arenaRow{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 14px;border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08); box-shadow:0 18px 60px rgba(0,0,0,.25); margin-bottom:12px}
  .arenaLeft{display:flex;flex-direction:column;gap:6px;min-width:0}
  .arenaTitle{display:block;font-weight:900;letter-spacing:.2px;color:rgba(233,240,255,.96);}
  .arenaMeta{font-size:12px;color:rgba(233,240,255,.68);line-height:1.25}
  .arenaLvl{display:block;font-size:12px;color:rgba(233,240,255,.85);font-weight:700;margin-top:2px;}
  .arenaBuy{min-width:160px;padding:12px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);color:rgba(233,240,255,.92);font-weight:800;cursor:pointer}
  .arenaBuy:disabled{opacity:.55;cursor:not-allowed}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleBlock">
        <h1 class="title">Ball Bouncer</h1>
      <div class="subtitle">Created By Alex</div>
      </div>
      <div class="topRight">
        <div class="pill"><div class="k">BALLS</div><div class="v" id="money">0</div></div>
        <div class="pill"><div class="k">PER SECOND</div><div class="v" id="perSec">0</div></div>
        <div class="pill"><div class="k">PER BOUNCE (varies)</div><div class="v" id="perClick">1</div></div>

        <div class="pill"><div class="k">REBIRTHS</div><div class="v" id="rebirths">0</div></div>
        <div class="pill"><div class="k">REBIRTH MULT</div><div class="v" id="rebirthMult">1×</div></div>

      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="cardHead">
          <h2>Click</h2>
          <div class="hint">Watch the bouncy box • Buy upgrades • Unlock new tiers</div>
        </div>
        <div class="play">
          <div class="center">
            <div class="ballWrap">

              <div class="arenaWrap" id="arenaWrap">
                <canvas id="arena"></canvas>
                <div class="arenaHint">Balls spawn here when you buy upgrades • Earn on every bounce</div>
              </div>
            </div>

            <p class="sub">Current Ball: <b id="tierName">Red</b> • Bounce Multiplier: <b id="tierMult">1×</b></p>

            <div class="statRow">
              <div class="mini"><div class="k">Total Bounces</div><div class="v" id="bounces">0</div></div>
              <div class="mini"><div class="k">Owned Upgrades</div><div class="v" id="owned">0</div></div>
              <div class="mini"><div class="k">Unlocked Tiers</div><div class="v" id="unlocked">1 / 18</div></div>
            </div>

            <div class="row2">
              <button class="smallBtn" id="saveBtn">Save</button>
              <button class="smallBtn" onclick="openRPS()">Rock Paper Scissors</button>
              
              
        
      <button class="smallBtn" onclick="location.href='whats-new.html'">What&#39;s New</button>
              <button class="smallBtn" id="exportBtn">Export Save</button>
              <button class="smallBtn" id="importBtn">Import Save</button>
              <button class="smallBtn rebirthBtn" id="rebirthBtn">Rebirth</button>
              <button class="smallBtn" id="resetBtn">Reset</button>
            </div>
            <div class="row2" style="margin-top:12px; justify-content:center;">
              <div class="pill" style="gap:8px; padding:10px 10px;">
                <span class="k" style="margin-right:6px;">CODES</span>
                <input id="codeInput" placeholder="Enter code..." autocomplete="off"
                  style="width:220px; max-width:55vw; padding:10px 12px; border-radius:12px;
                         border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.20);
                         color:rgba(233,240,255,.92); outline:none; font-weight:800;" />
                <button class="smallBtn" id="redeemBtn">Redeem</button>
              </div>
            </div>

</div>
        </div>
      </section>

      <aside class="rightWrap">
      <div class="card shopCard">
        <div class="cardHead">
          <h2>Ball Shop</h2>
          
          <div class="hint" style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
            <span>Unlock by reaching the unlock cost</span>
            <span id="buyToggleWrap" class="toggleGroup" style="display:none">
              <button class="togBtn" data-buy="1">×1</button>
              <button class="togBtn" data-buy="5">×5</button>
              <button class="togBtn" data-buy="10">×10</button>
              <button class="togBtn" data-buy="100">×100</button>
            </span>
          </div>

        </div>
        <div class="shopBody">
          <div class="list" id="shopList"></div>
</div>
      
      </div>

      <div class="card arenaCard" id="arenaCard">
        <div class="cardHead">
          <h2>Arena Upgrades</h2>
          <div class="hint">Upgrade the arena for faster, better bounces. <span style='opacity:.75'>(Unlocks at Rebirth 2)</span></div>
        </div>
        <div class="shopBody">
          <div id="arenaUpgList"></div>
        </div>
      </div>

    </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>



  <!-- Dev Panel (not visible until unlocked by secret code) -->
  <div id="devPanelBackdrop" aria-hidden="true">
    <div id="devPanel" role="dialog" aria-label="Developer Panel">
      <div class="devRow" style="gap:12px;">
        <h3>Developer Panel</h3>
        <button class="smallBtn" id="devCloseBtn">Close</button>
      </div>

      <div class="devGrid">

        <div id="devAdminBallPreview" style="display:flex; gap:12px; align-items:center; padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));">
          <img src="assets/admin.png" alt="Admin Ball" style="width:56px; height:56px; border-radius:50%; object-fit:contain; filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));" />
          <div style="line-height:1.15">
            <div style="font-weight:800; letter-spacing:.02em;">Admin Ball</div>
            <div style="opacity:.78; font-size:12px;">Hidden tier — only available via this panel</div>
          </div>
        </div>

        <button class="smallBtn" id="devMaxRebirthsBtn">Give Max Rebirths</button>
        <button class="smallBtn" id="devGiveAdminBallBtn">Give Admin Ball</button>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input class="devInput" id="devMoneyInput" placeholder="Set balls amount (e.g. 12345, 10qd, 2.5M)" />
          <button class="smallBtn" id="devSetMoneyBtn">Set Balls</button>
        </div>
        <div class="devHelp">
          Tip: supports suffixes like <b>K</b>, <b>M</b>, <b>B</b>, <b>T</b>, <b>Qa</b>, <b>Qi</b>, <b>Dc</b> (case-insensitive). Example: <b>10qd</b> = 10 quadrillion.
        </div>
      </div>
    
<script>
(() => {
  const tiers = [
    { id:"red",        label:"Red",        unlockCost:0,            baseCost:15,             mult:1,        auto:0.2,        img:"assets/red.png" },
    { id:"orange",     label:"Orange",     unlockCost:120,          baseCost:120,            mult:3,        auto:1,          img:"assets/orange.png" },
    { id:"yellow",     label:"Yellow",     unlockCost:700,          baseCost:700,            mult:8,        auto:4,          img:"assets/yellow.png" },
    { id:"green",      label:"Green",      unlockCost:3500,         baseCost:3500,           mult:18,       auto:14,         img:"assets/green.png" },
    { id:"blue",       label:"Blue",       unlockCost:18000,        baseCost:18000,          mult:45,       auto:55,         img:"assets/blue.png" },
    { id:"purple",     label:"Purple",     unlockCost:90000,        baseCost:90000,          mult:120,      auto:220,        img:"assets/purple.png" },
    { id:"black",      label:"Black",      unlockCost:420000,       baseCost:420000,         mult:320,      auto:900,        img:"assets/black.png" },
    { id:"brown",      label:"Brown",      unlockCost:2000000,      baseCost:2000000,        mult:800,      auto:3500,       img:"assets/brown.png" },
    { id:"grey",       label:"Grey",       unlockCost:9000000,      baseCost:9000000,        mult:2000,     auto:14000,      img:"assets/grey.png" },
    { id:"bronz",      label:"Bronz",      unlockCost:45000000,     baseCost:45000000,       mult:5500,     auto:60000,      img:"assets/bronz.png" },
    { id:"silver",     label:"Silver",     unlockCost:220000000,    baseCost:220000000,      mult:14000,    auto:240000,     img:"assets/silver.png" },
    { id:"gold",       label:"Gold",       unlockCost:1000000000,   baseCost:1000000000,     mult:36000,    auto:1000000,    img:"assets/gold.png" },
    { id:"void",       label:"Void",       unlockCost:6000000000,   baseCost:6000000000,     mult:90000,    auto:4800000,    img:"assets/void.png" },
    { id:"world",      label:"World",      unlockCost:30000000000,  baseCost:30000000000,    mult:230000,   auto:22000000,   img:"assets/world.png" },
    { id:"galaxy",     label:"Galaxy",     unlockCost:180000000000, baseCost:180000000000,   mult:600000,   auto:110000000,  img:"assets/galaxy.png" },
    { id:"universe",   label:"Universe",   unlockCost:1100000000000,baseCost:1100000000000,  mult:1700000,  auto:600000000,  img:"assets/universe.png" },
    { id:"multiverse", label:"Multiverse", unlockCost:7000000000000,baseCost:7000000000000,  mult:5000000,  auto:3000000000, img:"assets/multiverse.png" },
    { id:"galactic_orange", label:"Galactic Orange", unlockCost:50000000000000, baseCost:50000000000000, mult:15000000, auto:12000000000, img:"assets/galactic_orange.png" },
    { id:"admin", label:"Admin Ball", unlockCost:1e309, baseCost:1e309, mult:1000000000000, auto:5000000000, img:"assets/admin.png", adminOnly:true }
  ];

  const KEY = "ball_clicker_save_v3";
  try { localStorage.setItem("__ball_game_save_key", KEY); } catch(e) {}
  const LEGACY_KEYS = ["ball_clicker_save_v2", "ball_clicker_save_v1"];
  const inflation = 0.12;
  const REBIRTH_MAX = 4;
  const REBIRTH_PERMULT = 2; // each rebirth doubles all earnings; stacks: 2^rebirths
  const REBIRTH_REQ = [
    7_000_000_000_000,              // Rebirth 1
    500_000_000_000_000,          // Rebirth 2 (500T)
    5_000_000_000_000_000,        // Rebirth 3 (5QD)
    750_000_000_000_000_000       // Rebirth 4 (750QD)
  ]; // money required for rebirth 1 and 2
  const AUTOBOUNCE_RATE = 18; // bounces per second unlocked at rebirth 2

  const defaultState = () => ({
    money: 15,
    totalBounces: 0,
    owned: Object.fromEntries(tiers.filter(Boolean).map(t => [t.id, 0])),
    cost:  Object.fromEntries(tiers.filter(Boolean).map(t => [t.id, t.baseCost])),
    unlocked: Object.fromEntries(tiers.filter(Boolean).map(t => [t.id, t.unlockCost === 0])),
    activeTierId: "red",
    lastTick: Date.now(),
    rebirths: 0,
    buyAmount: 1,
    redeemedCodes: {},
    devUnlocked: false,
    balls: [],
    arenaUpg: { bonus:0, speed:0, cap:0 },
    version: 4
  });

  let state = load();

  
  // expose state for arena upgrades helpers
  try { window.state = state; window.__STATE_EXPOSED = true; } catch(e) {}

  // expose core funcs for overlays/upgrades
  try {
    window.renderAll = renderAll;
    window.canAfford = canAfford;
    window.fmt = fmt;
    window.showToast = showToast;
    window.save = save;
    window.__CORE_EXPOSED = true;
  } catch(e) {}

const $ = (id) => document.getElementById(id);
  const moneyEl = $("money"), perSecEl = $("perSec"), perClickEl = $("perClick");
  const bouncesEl = $("bounces"), ownedEl = $("owned"), unlockedEl = $("unlocked");
  const ballEl = $("ball"), floatingEl = $("floating"), shopList = $("shopList");
  const tierNameEl = $("tierName"), tierMultEl = $("tierMult"), toastEl = $("toast");
  const arenaCanvas = document.getElementById("arena");
  const arenaWrap = document.getElementById("arenaWrap");

  
  const arenaUpgListEl = document.getElementById("arenaUpgList");
const rebirthsEl = $("rebirths"), rebirthMultEl = $("rebirthMult");
  const buyToggleWrap = document.getElementById("buyToggleWrap");
  const buyBtns = buyToggleWrap ? Array.from(buyToggleWrap.querySelectorAll("button[data-buy]")) : [];

  function refreshBuyToggles(){
    if (!buyToggleWrap) return;
    const unlocked = (state.rebirths||0) >= 1;
    buyToggleWrap.style.display = unlocked ? "flex" : "none";
    if (!unlocked) state.buyAmount = 1;
    const cur = Math.max(1, Math.floor(state.buyAmount||1));
    for (const b of buyBtns){
      const v = parseInt(b.getAttribute("data-buy")||"1", 10);
      b.classList.toggle("active", v === cur);
      b.disabled = !unlocked;
      b.title = unlocked ? `Buy ×${v}` : "Unlocks at Rebirth 1";
    }
  }

  for (const b of buyBtns){
    b.addEventListener("click", () => {
      if ((state.rebirths||0) < 1){
        showToast("Bulk buy unlocks at Rebirth 1.");
        return;
      }
      const v = parseInt(b.getAttribute("data-buy")||"1", 10);
      state.buyAmount = [1,5,10,100].includes(v) ? v : 1;
      refreshBuyToggles();
      save();
    
    if (window.renderArenaUpgrades) window.renderArenaUpgrades();
});
  }

  function fmt(n){
    if (!isFinite(n)) return "∞";
    const abs = Math.abs(n);
    if (abs < 1000) return (Math.round(n*100)/100).toString().replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1");
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"];
    let u=-1, v=abs;
    while (v>=1000 && u<units.length-1){ v/=1000; u++; }
    const val = abs/Math.pow(1000,u+1);
    const str = val>=100 ? val.toFixed(0) : val>=10 ? val.toFixed(1) : val.toFixed(2);
    return (n<0? "-" : "") + str.replace(/\.0+$/,"") + units[u];
  }


  function rebirthMultiplier(){
    return Math.pow(REBIRTH_PERMULT, Math.max(0, Math.min(REBIRTH_MAX, state.rebirths||0)));
  }


  // --- Arena Simulation (balls bounce, earn on wall hit) ---
  let arenaCtx = null;
  let arenaW = 0, arenaH = 0, dpr = 1;
  let lastFrame = performance.now();

  const BALL_BASE_R = 18; // px
  const MAX_SIM_BALLS = 500; // safety cap

  function tierForId(id){ return tiers.find(t => t.id === id) || tiers[0]; }

  function resizeArena(){
    if (!arenaCanvas || !arenaWrap) return;
    dpr = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    const rect = arenaWrap.getBoundingClientRect();
    arenaW = Math.max(320, rect.width);
    arenaH = Math.max(220, rect.height);
    arenaCanvas.width = Math.floor(arenaW * dpr);
    arenaCanvas.height = Math.floor(arenaH * dpr);
    arenaCanvas.style.width = arenaW + "px";
    arenaCanvas.style.height = arenaH + "px";
    arenaCtx = arenaCanvas.getContext("2d");
    arenaCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function rand(min, max){ return min + Math.random() * (max - min); }

  function spawnBall(tierId){
    if (!state.balls) state.balls = [];
    if (state.balls.length >= (window.simBallCap ? window.simBallCap() : MAX_SIM_BALLS)) return;

    const t = tierForId(tierId);
    const idx = (t.idx ?? tiers.indexOf(t)) || 0;
    const r = BALL_BASE_R + Math.min(18, idx * 0.8);
    const x = rand(r+10, arenaW - r - 10);
    const y = rand(r+10, arenaH - r - 10);
    const speed = rand(160, 260) * (0.9 + 0.05*idx) * (window.speedMult ? window.speedMult() : 1);
    const ang = rand(0, Math.PI*2);
    const vx = Math.cos(ang) * speed;
    const vy = Math.sin(ang) * speed;
    state.balls.push({ id: tierId, x, y, vx, vy, r });
  }

  // Preload tier images
  const tierImgs = {};
  function getTierImg(id){
    if (tierImgs[id]) return tierImgs[id];
    const img = new Image();
    img.src = `assets/${id}.png`;
    tierImgs[id] = img;
    return img;
  }

  function earnOnBounce(tierId){
    // Each ball earns based on its own tier multiplier (not global power)
    const t = tierForId(tierId);
    const tierMult = (t && t.mult) ? t.mult : 1;
    const rb = rebirthMultiplier();
    const arenaB = (window.bounceBonusMult ? window.bounceBonusMult() : 1);
    const gain = tierMult * rb * arenaB;

    state.money += gain;
    state.totalBounces = (state.totalBounces||0) + 1;
    state._shopDirty = true;
    state._arenaDirty = true;
  }

  function stepArena(dt){
    if (!state.balls || !state.balls.length) return;
    for (const b of state.balls){
b.x += b.vx * dt;
      b.y += b.vy * dt;

      let bounced = false;
      if (b.x - b.r < 0){ b.x = b.r; b.vx = Math.abs(b.vx); bounced = true; }
      else if (b.x + b.r > arenaW){ b.x = arenaW - b.r; b.vx = -Math.abs(b.vx); bounced = true; }

      if (b.y - b.r < 0){ b.y = b.r; b.vy = Math.abs(b.vy); bounced = true; }
      else if (b.y + b.r > arenaH){ b.y = arenaH - b.r; b.vy = -Math.abs(b.vy); bounced = true; }

      if (bounced){
        earnOnBounce(b.id);
      }
    }
  }

  function drawArena(){
    if (!arenaCtx) return;
    arenaCtx.clearRect(0,0,arenaW,arenaH);

    const grd = arenaCtx.createRadialGradient(arenaW*0.35, arenaH*0.28, 40, arenaW*0.5, arenaH*0.5, Math.max(arenaW,arenaH)*0.8);
    grd.addColorStop(0, "rgba(56,189,248,0.07)");
    grd.addColorStop(0.45, "rgba(255,255,255,0.02)");
    grd.addColorStop(1, "rgba(0,0,0,0.10)");
    arenaCtx.fillStyle = grd;
    arenaCtx.fillRect(0,0,arenaW,arenaH);

    if (!state.balls) return;
    for (const b of state.balls){
      const img = getTierImg(b.id);
      const size = b.r*2;

      // shadow
      arenaCtx.save();
      arenaCtx.globalAlpha = 0.25;
      arenaCtx.beginPath();
      arenaCtx.ellipse(b.x+2, b.y+6, b.r*0.95, b.r*0.75, 0, 0, Math.PI*2);
      arenaCtx.fillStyle = "rgba(0,0,0,0.8)";
      arenaCtx.fill();
      arenaCtx.restore();

      // image clipped to circle
      arenaCtx.save();
      arenaCtx.beginPath();
      arenaCtx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      arenaCtx.clip();
      if (img.complete && img.naturalWidth > 0){
        arenaCtx.drawImage(img, b.x - b.r, b.y - b.r, size, size);
      } else {
        const g = arenaCtx.createLinearGradient(b.x-b.r, b.y-b.r, b.x+b.r, b.y+b.r);
        g.addColorStop(0, "rgba(56,189,248,0.35)");
        g.addColorStop(1, "rgba(34,197,94,0.25)");
        arenaCtx.fillStyle = g;
        arenaCtx.fillRect(b.x - b.r, b.y - b.r, size, size);
      }
      arenaCtx.restore();

      // rim
      arenaCtx.save();
      arenaCtx.strokeStyle = "rgba(255,255,255,0.10)";
      arenaCtx.lineWidth = 2;
      arenaCtx.beginPath();
      arenaCtx.arc(b.x, b.y, b.r-1, 0, Math.PI*2);
      arenaCtx.stroke();
      arenaCtx.restore();
    }
  }

  
  // Economy tick (earn per second, shop refresh, autosave)
  function scheduleArenaRender(now = performance.now()){
    if (!window.renderArenaUpgrades) return;
    // prevent DOM rebuild while user is interacting (avoids needing multiple clicks)
    if (scheduleArenaRender._freezeUntil && now < scheduleArenaRender._freezeUntil) return;
    const last = scheduleArenaRender._last || 0;
    if (now - last < 250) return; // throttle to 4x/sec
    scheduleArenaRender._last = now;
    window.renderArenaUpgrades();
  }
  function freezeArenaRender(ms){
    const now = performance.now();
    scheduleArenaRender._freezeUntil = Math.max(scheduleArenaRender._freezeUntil||0, now + ms);
  }

  function frameEconomy(now){
    // use high precision time from rAF
    const last = state.lastTick || now;
    const dt = Math.max(0, (now - last) / 1000);
    state.lastTick = now;

    const ps = calcPerSecond();
    if (ps > 0 && dt > 0) state.money += ps * dt;

    unlockCheck();


    if (state._shopDirty){
      state._shopDirty = false;
      renderShop();
      
    if (window.renderArenaUpgrades) window.renderArenaUpgrades();
frameEconomy._shop = 0;
          scheduleArenaRender(now);
}

    if (state._arenaDirty){
      state._arenaDirty = false;
      scheduleArenaRender();
}

    frameEconomy._shop = (frameEconomy._shop || 0) + dt;
    if (frameEconomy._shop >= 0.2){ frameEconomy._shop = 0; renderShop(); scheduleArenaRender();
}

    frameEconomy._save = (frameEconomy._save || 0) + dt;
    if (frameEconomy._save >= 8){ frameEconomy._save = 0; save(); }
  }

  function arenaLoop(now){
    const dt = Math.min(0.033, Math.max(0.0, (now - lastFrame) / 1000));
    lastFrame = now;
    stepArena(dt);
    drawArena();
    frameEconomy(now);
    renderHUD();
    requestAnimationFrame(arenaLoop);
  }

  function initArena(){
    resizeArena();
    window.addEventListener("resize", resizeArena);
    requestAnimationFrame((t) => { lastFrame = t; requestAnimationFrame(arenaLoop); });
  }

  function showToast(msg){

    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1400);
  }

  function getTier(id){ return tiers.find(t => t.id === id); }
  function totalOwned(){ return tiers.reduce((s,t)=>s+(state.owned[t.id]||0),0); }

  function calcPerSecond(){
    let s = 0;
    for (const t of tiers) s += (state.owned[t.id]||0)*t.auto;

    // rebirth 2: fast auto clicker = AUTOBOUNCE_RATE bounces/sec using current click power
    if ((state.rebirths||0) >= 2){
      s += AUTOBOUNCE_RATE * calcClickPowerRaw();
    }

    return s * rebirthMultiplier();
  }
  function calcClickPowerRaw(){
    let p = 1;
    for (const t of tiers) p += (state.owned[t.id]||0)*t.mult;
    // arena bonus affects earnings per bounce/click
    const bonus = (window.bounceBonusMult ? window.bounceBonusMult() : 1);
    return p * bonus;
  }
  function calcClickPower(){
    return calcClickPowerRaw() * rebirthMultiplier();
  }

  function bestUnlockedTier(){
    let hi=0;
    for (let i=0;i<tiers.length;i++) if (state.unlocked[tiers[i].id]) hi=i;
    let bestOwned=-1;
    for (let i=0;i<=hi;i++) if ((state.owned[tiers[i].id]||0)>0) bestOwned=i;
    return tiers[(bestOwned>=0)?bestOwned:hi].id;
  }

  function applyBallVisual(){
    const t = getTier(state.activeTierId);
    tierNameEl.textContent = t.label;
    tierMultEl.textContent = `${t.mult}×`;
    // big clickable ball was replaced by the arena; keep visuals only if element exists
    if (ballEl) ballEl.style.backgroundImage = `url('${t.img}')`;
  }

  function unlockCheck(){
    let unlockedCount=0;
    for (const t of tiers){
      if (t.adminOnly) continue;
      const was=!!state.unlocked[t.id];
      const now= was || state.money >= t.unlockCost;
      state.unlocked[t.id]=now;
      if (!was && now) showToast(`Unlocked: ${t.label} Ball!`);
      if (now) unlockedCount++;
    }
    unlockedEl.textContent = `${unlockedCount} / ${tiers.length}`;
    const prev = state.activeTierId;
    state.activeTierId = bestUnlockedTier();
    if (prev !== state.activeTierId) applyBallVisual();
  }

  function canAfford(cost){
    // Float-safe affordability check (prevents "Need" desync when money is earned continuously)
    return (state.money + 1e-6) >= cost;
  }

  function buyTier(id){
    if (!state.unlocked[id]) return;

    const qtyTarget = Math.max(1, Math.floor(state.buyAmount || 1));
    let bought = 0;

    for (let i = 0; i < qtyTarget; i++){
      const c = state.cost[id];
      if (!canAfford(c)) break;
      state.money -= c;
      state.owned[id] = (state.owned[id]||0) + 1;
      state.cost[id] = Math.ceil(c * (1 + inflation));
      spawnBall(id);
      bought++;
    }
    if (bought > 0){
      state.activeTierId = bestUnlockedTier();
      applyBallVisual();
      renderAll();
        refreshBuyToggles();
  scheduleArenaRender();
save();
    }
  }

  const shopItems = new Map();

  function makeItem(t){
    const el = document.createElement("div");
    el.className = "item";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.style.backgroundImage = `url('${t.img}')`;

    const mid = document.createElement("div");
    const name = document.createElement("p");
    name.className = "name";
    name.innerHTML = `${t.label} <span style="color:rgba(233,240,255,.55); font-weight:800; font-size:12px;">(Tier)</span>`;
    const meta = document.createElement("p");
    meta.className = "meta";
    mid.appendChild(name); mid.appendChild(meta);

    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = "Buy";
    btn.onclick = () => buyTier(t.id);

    el.appendChild(badge); el.appendChild(mid); el.appendChild(btn);
    el._btn = btn; el._meta = meta; el._tier = t;
    return el;
  }

  function renderShop(){
    if (shopItems.size === 0){
      shopList.innerHTML = "";
      for (const t of tiers){
      if (t.adminOnly) continue;
        const item = makeItem(t);
        shopItems.set(t.id, item);
        shopList.appendChild(item);
      }
    }
    for (const t of tiers){
      if (t.adminOnly) continue;
      const item = shopItems.get(t.id);
      const isUnlocked = !!state.unlocked[t.id];
      item.classList.toggle("locked", !isUnlocked);

      const affordable = canAfford(state.cost[t.id]);
      item._btn.disabled = !isUnlocked || !affordable;

      item._meta.innerHTML = `
        Owned: <b>${fmt(state.owned[t.id]||0)}</b> • Cost: <b>${fmt(state.cost[t.id])}</b><br/>
        Bounce +<b>${fmt(t.mult)}</b> each • Auto +<b>${fmt(t.auto)}</b>/sec each<br/>
        Unlock at: <b>${fmt(t.unlockCost)}</b>
      `;
      const qty = Math.max(1, Math.floor(state.buyAmount || 1));
      if (!isUnlocked){
        item._btn.textContent = "Locked";
      } else if (affordable){
        item._btn.textContent = (qty === 1) ? "Buy" : ("Buy ×" + qty);
      } else {
        item._btn.textContent = "Need: " + fmt(state.cost[t.id]);
      }
    }
  }

  function renderHUD(){
    moneyEl.textContent = fmt(state.money);
    perSecEl.textContent = fmt(calcPerSecond());
    perClickEl.textContent = fmt(calcClickPower());
    rebirthsEl.textContent = fmt(state.rebirths||0);
    rebirthMultEl.textContent = `${fmt(rebirthMultiplier())}×`;
    bouncesEl.textContent = fmt(state.totalBounces);
    ownedEl.textContent = fmt(totalOwned());
    updateRebirthButton();
  }

  function syncBuyToggle(){
    if (!buyToggleWrap) return;
    const enabled = (state.rebirths||0) >= 1;
    buyToggleWrap.style.display = enabled ? "flex" : "none";
    const current = Math.max(1, Math.floor(state.buyAmount || 1));
    for (const b of buyBtns){
      b.classList.toggle("active", Number(b.dataset.buy) === current);
    }
  }

  function renderAll(){
    unlockCheck();
    renderHUD();
    syncBuyToggle();
    renderShop();
    scheduleArenaRender();
syncDevPanel();
  }

  function clickBall(){
    const pc = calcClickPower();
    state.money += pc;
    state.totalBounces += 1;
    floatingEl.textContent = `+${fmt(pc)}`;
    floatingEl.classList.remove("show"); void floatingEl.offsetWidth;
    floatingEl.classList.add("show");
    clearTimeout(clickBall._t);
    clickBall._t = setTimeout(() => floatingEl.classList.remove("show"), 220);
    renderAll();
  }

  if (ballEl) ballEl.addEventListener("click", clickBall);
if (ballEl) ballEl.addEventListener("keydown", (e)=>{
    if (e.key==="Enter" || e.key===" "){ e.preventDefault(); clickBall(); }
  });

  function tick(){
    const now = Date.now();
    const dt = (now - state.lastTick) / 1000;
    state.lastTick = now;
    const ps = calcPerSecond();
    if (ps > 0 && dt > 0) state.money += ps * dt;

    unlockCheck();
    renderHUD();

    tick._shop = (tick._shop || 0) + dt;
    if (tick._shop >= 0.2){ tick._shop = 0; renderShop(); }

    tick._save = (tick._save || 0) + dt;
    if (tick._save >= 8){ tick._save = 0; save(); }

    requestAnimationFrame(tick);
  }

  function save(){
    try { localStorage.setItem("__ball_game_save_key", KEY); } catch(e) {} try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
  function openRPS(){ save(); location.href = (location.protocol==="file:" ? "rps.html" : "/rps"); }
  window.openRPS = openRPS;

  function load(){
    try{
      let raw = localStorage.getItem(KEY);
      if (!raw){
        for (const k of (LEGACY_KEYS||[])){
          raw = localStorage.getItem(k);
          if (raw) break;
        }
      }
      if (!raw) return defaultState();
      const data = JSON.parse(raw);
      const s = defaultState();
      s.money = +data.money || 0;
      s.totalBounces = +data.totalBounces || 0;
      s.lastTick = Date.now();
      for (const t of tiers){
        s.owned[t.id] = Math.max(0, Math.floor((data.owned?.[t.id] ?? 0)));
        s.cost[t.id]  = Math.max(1, +((data.cost?.[t.id] ?? t.baseCost)));
        s.unlocked[t.id] = !!(data.unlocked?.[t.id] ?? (t.unlockCost === 0));
      }
      s.activeTierId = (data.activeTierId && s.unlocked[data.activeTierId]) ? data.activeTierId : "red";
      s.rebirths = Math.max(0, Math.min(REBIRTH_MAX, Math.floor(data.rebirths ?? 0)));
      s.buyAmount = [1,5,10,100].includes(Math.floor(data.buyAmount ?? 1)) ? Math.floor(data.buyAmount ?? 1) : 1;
      s.redeemedCodes = (data.redeemedCodes && typeof data.redeemedCodes === "object") ? data.redeemedCodes : {};
      s.devUnlocked = !!(data.devUnlocked ?? false);
      s.balls = Array.isArray(data.balls) ? data.balls : [];
      s.arenaUpg = (data.arenaUpg && typeof data.arenaUpg === "object") ? data.arenaUpg : { bonus:0, speed:0, cap:0 };
      return s;
    }catch(e){ return defaultState(); }
  }

  function exportSave(){
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
    navigator.clipboard?.writeText(payload).then(
      ()=>showToast("Save copied to clipboard!"),
      ()=>prompt("Copy your save string:", payload)
    );
  }
  function importSave(){
    const input = prompt("Paste your save string:");
    if (!input) return;
    try{
      const json = decodeURIComponent(escape(atob(input.trim())));
      const data = JSON.parse(json);
      localStorage.setItem(KEY, JSON.stringify(data));
      state = load();
      applyBallVisual();
      renderAll();
          try{ window.state = state; }catch(e){}
save();
      showToast("Imported!");
    }catch(e){ showToast("Invalid save string."); }
  }
  function reset(){
    if (!confirm("Reset Ball Bouncer? This wipes your save.")) return;
    state = defaultState();
    try{ window.state = state; }catch(e){}
    save();
    applyBallVisual();
    renderAll();
    refreshBuyToggles();
    scheduleArenaRender();
showToast("Reset done.");
  }

  document.getElementById("saveBtn").addEventListener("click", ()=>{ save(); showToast("Saved."); });
  document.getElementById("exportBtn").addEventListener("click", exportSave);
  document.getElementById("importBtn").addEventListener("click", importSave);
  document.getElementById("resetBtn").addEventListener("click", reset);

  // Buy-amount toggles (unlocks at rebirth 1)
  if (buyBtns.length){
    for (const b of buyBtns){
      b.addEventListener("click", () => {
        const v = Number(b.dataset.buy);
        if (![1,5,10,100].includes(v)) return;
        state.buyAmount = v;
        syncBuyToggle();
        renderShop();
        save();
      });
    }
  }

  function canRebirth(){
    const r = Math.max(0, Math.floor(state.rebirths||0));
    if (r >= REBIRTH_MAX) return false;
    const req = REBIRTH_REQ[r]; // requirement for next rebirth
    return state.money >= req;
  }

  function doRebirth(){
    const r = Math.max(0, Math.floor(state.rebirths||0));
    if (r >= REBIRTH_MAX){
      showToast("Max rebirths reached (4).");
      return;
    }
    const req = REBIRTH_REQ[r];
    if (state.money < req){
      showToast(`Need: ${fmt(req)} to rebirth.`);
      return;
    }

    const next = r + 1;
    const multNow = Math.pow(REBIRTH_PERMULT, next);
    const msg = `Rebirth to #${next}? This resets your progress but keeps a permanent ${fmt(multNow)}× multiplier.`;
    if (!confirm(msg)) return;

    // Reset progression, keep rebirths and buy system unlock
    const keepRebirths = next;
    const keepBuy = (keepRebirths >= 1) ? (state.buyAmount || 1) : 1;

    state = defaultState();
    try{ window.state = state; }catch(e){}
    state.rebirths = keepRebirths;
    state.buyAmount = (keepRebirths >= 1) ? (keepBuy) : 1;
    state.lastTick = Date.now();

    applyBallVisual();
    renderAll();
    refreshBuyToggles();
    save();

    if (keepRebirths === 1){
      showToast("Rebirth complete! Buy ×5/×10/×100 unlocked.");
    } else if (keepRebirths === 2){
      showToast("Rebirth complete! Fast auto clicker unlocked.");
    } else {
      showToast("Rebirth complete!");
    }
  }

  document.getElementById("rebirthBtn").addEventListener("click", doRebirth);


  // --- Codes (secret rewards) ---
  function awardMoney(amount){
    state.money += amount;
    unlockCheck();
    renderAll();
    save();
  }

  // Add codes here (we can add more later)
  const CODES = {
    "WELOVEBALLS": {
      once: true,
      run: () => awardMoney(10_000_000_000_000_000) // 10qd
    },
    "STARTER": {
      once: true,
      run: () => awardMoney(100_000) // 100k
    },
    "ALEXELLIOTTMADETHISGAME": {
      once: false,
      run: () => {
        state.devUnlocked = true;
        save();
        setDevPanelVisible(true);
        showToast("Dev panel unlocked.");
      }
    },

  };

  function redeemCode(raw){
    const code = (raw || "").trim().toUpperCase();
    if (!code) return;

    const entry = CODES[code];
    if (!entry){
      showToast("Invalid code.");
      return;
    }
    state.redeemedCodes = state.redeemedCodes || {};
    if (entry.once && state.redeemedCodes[code]){
      showToast("Code already used.");
      return;
    }
    try{
      entry.run();
      state.redeemedCodes[code] = true;
      showToast("Code redeemed!");
      save();
    }catch(e){
      showToast("Code failed.");
    }
  }

  const codeInput = document.getElementById("codeInput");
  const redeemBtn = document.getElementById("redeemBtn");
  if (redeemBtn && codeInput){
    redeemBtn.addEventListener("click", () => {
      redeemCode(codeInput.value);
      codeInput.value = "";
    });
    codeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        redeemCode(codeInput.value);
        codeInput.value = "";
      }
    });
  }

  // --- Dev Panel (only visible after secret dev code is redeemed) ---
  const devBackdrop = document.getElementById("devPanelBackdrop");
  const devCloseBtn = document.getElementById("devCloseBtn");
  const devMaxRebirthsBtn = document.getElementById("devMaxRebirthsBtn");
  const devGiveAdminBallBtn = document.getElementById("devGiveAdminBallBtn");
  function devGiveAdminBall(){
    // Unlock + grant 1 Admin Ball (not shown in shop)
    if (!state.unlocked) state.unlocked = {};
    if (!state.owned) state.owned = {};
    if (!state.cost) state.cost = {};
    state.unlocked["admin"] = true;
    state.owned["admin"] = (state.owned["admin"]||0) + 1;
    state.cost["admin"] = 1e309;

    // Set active tier to admin for UI
    state.activeTierId = "admin";

    // Ball Bouncer: spawn into arena. Ball Clicker: just updates power/auto via owned.
    if (typeof spawnBall === "function"){
      try { spawnBall("admin"); } catch(e) {}
    }
    toast("Admin Ball granted!");
    state._shopDirty = true;
    state._arenaDirty = true;
    renderAll();
    save();
  }

  const devMoneyInput = document.getElementById("devMoneyInput");
  const devSetMoneyBtn = document.getElementById("devSetMoneyBtn");

  function setDevPanelVisible(on){
    if (!devBackdrop) return;
    devBackdrop.style.display = on ? "flex" : "none";
    devBackdrop.setAttribute("aria-hidden", on ? "false" : "true");
  }

  function syncDevPanel(){
    // panel stays completely hidden unless unlocked
    if (!state.devUnlocked){
      setDevPanelVisible(false);
    }
  }

  function parseAmount(input){
    const s = String(input || "").trim();
    if (!s) return null;
    // Allow commas/spaces
    const cleaned = s.replace(/[, ]+/g, "").toLowerCase();
    // Support scientific notation directly
    if (/^[+-]?\d+(\.\d+)?e[+-]?\d+$/i.test(cleaned)){
      const v = Number(cleaned);
      return isFinite(v) ? v : null;
    }
    // suffix map
    const suffixMap = {
      k: 1e3,
      m: 1e6,
      b: 1e9,
      t: 1e12,
      qa: 1e15,
      qd: 1e16, // quadrillion (requested)
      qi: 1e18,
      sx: 1e21,
      sp: 1e24,
      oc: 1e27,
      no: 1e30,
      dc: 1e33,
    };
    const match = cleaned.match(/^([+-]?\d+(?:\.\d+)?)([a-z]{1,2})?$/i);
    if (!match) return null;
    const num = Number(match[1]);
    if (!isFinite(num)) return null;
    const suf = match[2] || "";
    const mult = suf ? (suffixMap[suf] ?? null) : 1;
    if (mult == null) return null;
    return num * mult;
  }

  // Dev actions
  function devGiveMaxRebirths(){
    state.rebirths = REBIRTH_MAX;
    // Ensure buy toggles exist and set to a safe default
    state.buyAmount = [1,5,10,100].includes(state.buyAmount) ? state.buyAmount : 1;
    unlockCheck();
    applyBallVisual();
    renderAll();
    save();
    showToast("Dev: Max rebirths granted.");
  }

  function devSetMoney(){
    const v = parseAmount(devMoneyInput?.value);
    if (v == null || !isFinite(v) || v < 0){
      showToast("Dev: Invalid amount.");
      return;
    }
    state.money = v;
    unlockCheck();
    renderAll();
    save();
    showToast("Dev: Balls set.");
  }

  if (devCloseBtn && devBackdrop){
    devCloseBtn.addEventListener("click", () => setDevPanelVisible(false));
    devBackdrop.addEventListener("click", (e) => {
      if (e.target === devBackdrop) setDevPanelVisible(false);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setDevPanelVisible(false);
    });
  }
  if (devMaxRebirthsBtn) devMaxRebirthsBtn.addEventListener("click", devGiveMaxRebirths);
  if (devGiveAdminBallBtn) devGiveAdminBallBtn.addEventListener("click", devGiveAdminBall);
  if (devSetMoneyBtn) devSetMoneyBtn.addEventListener("click", devSetMoney);
  if (devMoneyInput) devMoneyInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") devSetMoney();
  });

  // Update rebirth button state periodically
  function updateRebirthButton(){
    const btn = document.getElementById("rebirthBtn");
    if (!btn) return;
    const r = Math.max(0, Math.floor(state.rebirths||0));
    if (r >= REBIRTH_MAX){
      btn.textContent = "Rebirth (Max)";
      btn.disabled = true;
      return;
    }
    const req = REBIRTH_REQ[r];
    const ok = state.money >= req;
    btn.disabled = !ok;
    btn.textContent = ok ? `Rebirth (${r+1}/${REBIRTH_MAX})` : `Rebirth • Need: ${fmt(req)}`;
  }

  applyBallVisual();
  initArena();
  renderAll();
  syncDevPanel();
  state.lastTick = Date.now();
  requestAnimationFrame(arenaLoop);

/* Arena Upgrades UI + API (global) */
(function(){
  const $ = (id)=>document.getElementById(id);
  const list = $("arenaUpgList");

  function canUseArena(){ return (window.state && (window.state.rebirths||0) >= 2); }

  const ARENA_UPGS = [
    { id:"bonus", name:"Bounce Bonus", desc:"+25% bounce earnings per level", base: 500_000, growth: 1.2175644451521461, max: 25, target: "100T" },
    { id:"speed", name:"Speed Core",  desc:"+15% initial ball speed per level", base: 525_000, growth: 1.7598254568446654, max: 20, target: "125T" },
    { id:"cap",   name:"Capacity",    desc:"+100 max balls per level", base: 550_000, growth: 1.7796218325436910, max: 20, target: "150T" },
  ];

  function ensureArenaState(){
    if(!window.state) return;
    window.state.arenaUpg = (window.state.arenaUpg && typeof window.state.arenaUpg === "object") ? window.state.arenaUpg : { bonus:0, speed:0, cap:0 };
    // sanitize numeric levels
    for (const k of ["bonus","speed","cap"]){
      const v = Number(window.state.arenaUpg[k] || 0);
      window.state.arenaUpg[k] = Number.isFinite(v) ? Math.max(0, Math.floor(v)) : 0;
    }
  }
  function arenaLvl(id){ ensureArenaState(); return Math.max(0, Math.floor((window.state.arenaUpg && window.state.arenaUpg[id]) || 0)); }
  function arenaCost(u){ const lvl=arenaLvl(u.id); return Math.ceil(u.base * Math.pow(1 + u.growth, lvl)); }

  window.bounceBonusMult = function(){ return Math.pow(1.25, arenaLvl("bonus")); };
  window.speedMult = function(){ return Math.pow(1.15, arenaLvl("speed")); };
  window.simBallCap = function(){ return ((typeof window.MAX_SIM_BALLS === "number") ? window.MAX_SIM_BALLS : (typeof MAX_SIM_BALLS === "number" ? MAX_SIM_BALLS : 500)) + 100*arenaLvl("cap"); };

  window.buyArenaUpg = function(id){
    freezeArenaRender(500);
    const u = ARENA_UPGS.find(x=>x.id===id);
    if(!u || !window.state) return;
    const lvl = arenaLvl(id);
    if(lvl >= u.max){ (window.showToast?showToast:console.log)("Max level reached."); return; }
    let cost = arenaCost(u);
      if (!Number.isFinite(cost)) cost = Infinity;
    const afford = window.canAfford ? canAfford(cost) : (window.state.money >= cost);
    if(!afford){ (window.showToast?showToast:console.log)("Not enough balls."); return; }
    window.state.money -= cost;
    window.state.arenaUpg[id] = lvl + 1;
    // Apply Speed Core instantly to existing balls so the whole arena benefits right away
    if (id === "speed" && Array.isArray(window.state.balls)) {
      const boost = 1.15; // per level
      for (const b of window.state.balls) {
        if (!b) continue;
        if (typeof b.vx === "number") b.vx *= boost;
        if (typeof b.vy === "number") b.vy *= boost;
        if (typeof b.dx === "number") b.dx *= boost;
        if (typeof b.dy === "number") b.dy *= boost;
      }
    }

    if(window.save) save();
    if(window.renderAll) renderAll();
    scheduleArenaRender();
};

  window.renderArenaUpgrades = function(){
    if (!arenaUpgListEl) return;

    const unlocked = canUseArena();
    // Build DOM once for stability (prevents missed clicks)
    if (!arenaUpgListEl._built){
      arenaUpgListEl.innerHTML = "";
      arenaUpgListEl._rows = {};

      for (const u of ARENA_UPGS){
        const row = document.createElement("div");
        row.className = "arenaRow";

        const left = document.createElement("div");
        left.className = "arenaLeft";

        const title = document.createElement("div");
        title.className = "arenaTitle";
        title.textContent = `${u.name} • Level 0/${u.max}`;

        const meta = document.createElement("div");
        meta.className = "arenaMeta";
        meta.textContent = u.desc;

        const lvl = document.createElement("div");
        lvl.className = "arenaLvl";
        lvl.textContent = `Level 0/${u.max}`;

        left.appendChild(title);
        left.appendChild(meta);
        left.appendChild(lvl);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "arenaBuy";
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          buyArenaUpg(u.id);
        });

        row.appendChild(left);
        row.appendChild(btn);
        arenaUpgListEl.appendChild(row);
        arenaUpgListEl._rows[u.id] = {row, title, lvl, btn};
      }

      arenaUpgListEl._built = true;
    }

    // Update only (no rebuild)
    for (const u of ARENA_UPGS){
      const r = arenaUpgListEl._rows[u.id];
      if (!r) continue;      const level = (typeof arenaLvl === "function") ? arenaLvl(u.id) : ((state.arenaUpg && state.arenaUpg[u.id]) ? state.arenaUpg[u.id] : ((state.arena && state.arena[u.id]) ? state.arena[u.id] : 0));
const maxed = level >= u.max;
      const cost = arenaCost(u, level);

      r.title.textContent = `${u.name} • Level ${level}/${u.max}`;
      r.lvl.textContent = `Level ${level}/${u.max}`;

      if (!unlocked){
        r.btn.disabled = true;
        r.btn.textContent = "Locked";
        r.row.style.opacity = 0.6;
        continue;
      }

      r.row.style.opacity = 1;

      if (maxed){
        r.btn.disabled = true;
        r.btn.textContent = "Max";
        continue;
      }

      const ok = canAfford(cost);
      r.btn.disabled = !ok;
      r.btn.textContent = ok ? "Buy" : `Need: ${fmt(cost)}`;
      r.btn.title = ok ? "Buy upgrade" : `Need: ${fmt(cost)}`;
    }
  };

  // Try to render once the page is ready and state exists
  const tryRender = ()=>{
    if(window.state && list){
      scheduleArenaRender();
return true;
    }
    return false;
  };
  document.addEventListener("DOMContentLoaded", ()=>{
    if(!tryRender()){
      let n=0;
      const t=setInterval(()=>{ n++; if(tryRender()||n>20) clearInterval(t); }, 200);
    }
  });
})();
})();
</script>

</body>
</html>